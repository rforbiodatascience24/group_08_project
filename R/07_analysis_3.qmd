---
title: "07_analysis_3"
format: html
editor: visual
---

## Load Libraries

```{r}
library(tidyverse)
library(ggplot2)
library(here)
source("99_proj_func.R")
```

## Load data

```{r}
# load data
mbc_log2_transformed <- read_csv(here("data/03_dat_aug_05.csv"))
# view data
print(long_data)
```

## Analysis

```{r}
mbc_log2_transformed
```

### Calculate slope

```{r}
# Calculate slopes for each person
slopes <- wide_data |> 
  group_by(patient) |> 
  summarize(slope = lm(log2(post_count) ~ log2(pre_count))$coefficients[2]) # Extract slope
```

```{r}

long_data <- long_data |> 
  mutate(patient = str_extract(count_type, "\\d+")) # extract experiments individually

wide_data <- long_data |> 
  pivot_wider(names_from = count_type, values_from = count_value) |> 
  rowwise() |> 
  mutate(pre_count = get(paste0("pre_count_", patient)),
         post_count = get(paste0("post_count_", patient))) |> 
  ungroup()

# Scatter plot with dynamic faceting
ggplot(wide_data, aes(x = log2(pre_count), y = log2(post_count), color = patient)) +
  geom_point(size = 0.3) +
  geom_text(data = slopes, aes(x = Inf, y = Inf, label = sprintf("Slope: %.2f", slope)),
            inherit.aes = FALSE, hjust = 2, vjust = 1.5, color = "black", size = 3) + 
  geom_smooth(method = "lm") +
  labs(title = "Scatter Plot of Pre-count vs Post-count Values",
       x = "Log2 Pre-count Values",
       y = "Log2 Post-count Values",
       color = "Patient") +
  theme_minimal() +
  facet_wrap(~ patient, scales = "free")

```
