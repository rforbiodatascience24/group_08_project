---
title: "06_analysis_2"
format: html
editor: visual
---

## Load Libraries

```{r}
library(tidyverse)
library(broom)
library(here)
source("99_proj_func.R")
```

## Load data

```{r}
long_data <- read_csv(here("data/03_dat_aug_02.csv"))
print(long_data)
```

### Augment Data

```{r}

mbc_log2_transformed <- long_data |>
  mutate(log2_transformed = log2(count_value)) |>
  rename(gene = name) |> 
  mutate(count_type = case_when(
                          str_detect(count_type, "^pre") ~ 0,
                          str_detect(count_type, "^post") ~ 1)) |> 
  relocate(treatment = count_type)
mbc_log2_transformed
```

## Analysis (make linear models)

```{r}
mbc_log2_transformed_nested <- mbc_log2_transformed |> 
  group_by(gene) |> 
  nest() |> 
  ungroup()

(mbc_log2_transformed_nested)
```

```{r}
mbc_log2_transformed_nested <- mbc_log2_transformed_nested |> 
  group_by(gene) |> 
  mutate(model_object = map(
    .x = data,
    .f = ~lm(formula = log2_transformed ~ treatment,
             data = .x)))
(mbc_log2_transformed_nested)
```

```{r}
mbc_log2_transformed_nested |>
  filter(gene == "CCNO") |>
  pull(model_object) |> 
  pluck(1) |> 
  tidy(conf.int = TRUE,
       conf.level = 0.95)
```

### Make the variable model_object_tidy 

```{r}
mbc_log2_transformed_nested <- mbc_log2_transformed_nested |> 
  group_by(gene) |> 
  mutate(model_object_tidy = map(
    .x = model_object,
    .f = ~tidy(x = .x,
               conf.int = TRUE,
               conf.level = 0.95)))
mbc_log2_transformed_nested
```

### Make the new variable **`estimates`**

```{r}
estimates <- mbc_log2_transformed_nested |> 
  unnest(model_object_tidy)
estimates
```

### only show slope, and ungroup

```{r}
estimates <- estimates |> 
  filter(term == "treatment") |> 
  select(gene, p.value, estimate, conf.low, conf.high) |> 
  ungroup()
estimates
```

adding q.value

```{r}
estimates <- estimates |> 
  mutate(q.value = p.adjust(p.value),
         is_significant = case_when(
                                    q.value < 0.05  ~ "yes", 
                                    q.value > 0.05 ~ "no"))
estimates |> 
  filter(is_significant == "yes")
```

```{r}
# Calculate log2 fold change
data_summary <- mbc_log2_transformed_grouped %>%
  group_by(gene) %>%
  summarise(
    log2_fold_change = log2_transformed[treatment == 1] - log2_transformed[treatment == 0],
    mean_treatment_0 = mean_count[treatment == 0],
    mean_treatment_1 = mean_count[treatment == 1]
  )

# View the results
print(data_summary)
```
