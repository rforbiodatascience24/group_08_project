---
title: "Gene expression analysis of combined treatment of metastatic breast cancer"
author: |
  Martin Vennick Haugbølle, 
  Cecilie Møller-Jensen, 
  Amanda Vinter Eichen, 
  Thomas Vitus, 
  Julie Alsing Haugaard
format:
  revealjs:
    code-line-numbers: true
    smaller: true
    scoll: true
    theme: dark
    transition: slide
editor: visual
---

```{r}
library(tidyverse)
library(here)
library(readr)
source("../R/99_proj_func.R")
```

# Analysis on the effect of combination treatment by gene expression for patients with metastatic breast cancer

## Study description

This study looks at how a combination of pembrolizumab, exemestane, and leuprolide affects the immune environment in premenopausal women with advanced breast cancer. It tracks changes in immune-related gene expression before and after treatment in 15 patients.

## Work method illustrated by a flowchart



## Raw -> tidy data


::: {.columns}

::: {.column width="35%"}
```{r}
#| echo: true
# Untidy single patient dataset
print(read.csv(here("data/01_dat_load_pre_data_GSM8152441.csv")))
```
:::

::: {.column width="65%"}
```{r}
#| echo: true
# Cleaned cobined pre and post data for 5 patients
print(read.csv(here("data/02_dat_clean.csv")))
```
:::

:::

## Augmentation of the data

```{r}
#| echo: true
#| results: hide
#| code-line-numbers: "2-4|5-10"

# Creating wide data frame
df_clean <- read.csv(here("data/02_dat_clean.csv"))

df_wide <- df_clean |>
  # replace outliers for pre and post_count columns
  replace_outliers_with_na("pre_count") |> 
  replace_outliers_with_na("post_count") |>
  rowwise() |> 
  # calculate means
  mutate(mean_pre = 
           round(mean(c_across(starts_with("pre_count")), na.rm = TRUE), 1), 
         mean_post = 
           round(mean(c_across(starts_with("post_count")), na.rm = TRUE), 1)) |>
  ungroup() |> 
  # fold change made of case/control
  mutate(log2_fold_change = log2(mean_post / mean_pre)) 

# save data
write_csv(df_wide, here("data/03_dat_aug_01.csv"))


# make a longer data frame with a row for each "count" variable
df_long <- df_wide |>  
  pivot_longer(
    cols = starts_with("pre_count") | starts_with("post_count"), # select count columns
    names_to = "treatment",  # new column for column names
    values_to = "count_value" # new column for values
  ) |> 
  mutate(log2_count_value = log2(count_value)) |> # calculate log2 of counts
  mutate(bin_treatment = case_when(
                          str_detect(treatment, "^pre") ~ 0, # change "pre" to 0
                          str_detect(treatment, "^post") ~ 1)) |> # change "post" to 1
  mutate(treatment = case_when(
                          str_detect(treatment, "^pre") ~ "pre", # change to "pre" 
                          str_detect(treatment, "^post") ~ "post"))

# save data
write_csv(df_long, here("data/03_dat_aug_02.csv"))
```



## Description results

## Analysis 1 results

## Distribution of log2 fold change per class

## Are there significane in the log2 fold change?

## Results

## Discussion
